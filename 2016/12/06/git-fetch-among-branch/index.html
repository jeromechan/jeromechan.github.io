<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Git协作之合并代码 &middot; 闲亭野径
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/poole.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <link rel="stylesheet" href="/assets/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-precomposed.png">
                                 <link rel="shortcut icon" href="/assets/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-black layout-reverse">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          闲亭野径
        </a>
      </h1>
      <p class="lead">闲谈生活趣事，辨识理想现实</p>
    </div>

    <nav class="sidebar-nav">
      <!--<a class="sidebar-nav-item" href="/">首页</a>-->
<!-- 
      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About Me</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/analysis/">行业分析</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/art/">音乐艺术</a>
          
        
      
        
      
        
          
            <a class="sidebar-nav-item" href="/pages/bibliography.html">读过的书目</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/categories/">Categories</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/coding/">技术编程</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/essay/">散文闲谈</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
      
        
          
            <a class="sidebar-nav-item" href="/photography/">摄影映画</a>
          
        
      
        
      
        
          
            <a class="sidebar-nav-item" href="/slides/">Slides</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/tags/">Tags</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/timeline/">Timeline</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
       -->

      <!--<a class="sidebar-nav-item" href="/bibliography/" target="_blank">Bibliography</a>-->
      <!--<a class="sidebar-nav-item" href="/slides/">演讲稿</a>-->
      <!--<a class="sidebar-nav-item" href="/tags/">标签</a>-->
      <!--<a class="sidebar-nav-item" href="/categories/">文章分类</a>-->
      <a class="sidebar-nav-item" href="/coding">技术编程</a>
      <a class="sidebar-nav-item" href="/analysis">行业分析</a>
      <a class="sidebar-nav-item" href="/photography">摄影映画</a>
      <a class="sidebar-nav-item" href="/art">音乐艺术</a>
      <a class="sidebar-nav-item" href="/essay">散文闲谈</a>
      <!--<a class="sidebar-nav-item" href="/timeline/">时间线</a>-->
      <!-- <a class="sidebar-nav-item" href="https://github.com/jeromechan">GitHub</a> -->
      <!-- <span class="sidebar-nav-item">Currently v2.1.0-u-jeromechan-01</span> -->
      <hr />
      <a class="sidebar-nav-item" href="/about">关于我</a>
    </nav>

    <p><small>Copyright &copy; 2013-2018</small></p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Git协作之合并代码</h1>
  <span class="post-date">06 Dec 2016</span>
  <p>继上一次撰写GIT相关文章已经数月有余，半年来在团队内实践GIT的过程中，遇到了很多个人项目所不会接触到的疑问和问题，最为典型的无异于分支、代码之间的合并操作。本篇我们来讲一讲如何在本地仓库中做好多人协作过程中的分支代码合并。</p>

<h4 id="一前言">一、前言</h4>

<ul>
  <li><strong>Git知识回顾</strong></li>
</ul>

<p>在开始之前，如果你对于GIT的基础知识已经有些遗忘了，可以参考以下这几篇文章，知识都比较基础：</p>

<ul>
  <li><a href="http://aboutcoder.com/2014/06/29/git-basic-knowledge-1/">GIT基础知识讲解（一）</a></li>
  <li><a href="http://aboutcoder.com/2014/06/29/git-basic-knowledge-2/">GIT基础知识讲解（二）</a></li>
</ul>

<p>如果你想将GIT流程应用到研发工作当中去，GIT流程是你必须要知道的：</p>

<ul>
  <li><a href="http://aboutcoder.com/2015/11/16/work-in-git/">Git软件开发过程</a></li>
</ul>

<p>希望上面几篇文章可以帮助到你学习和回顾GIT应用知识。</p>

<ul>
  <li><strong>冲突产生的原因以及合并操作的原则</strong></li>
</ul>

<p>如果你对Git有了以上方面的了解，那么在学习如何进行冲突解决之前，可以先了解为什么会产生冲突？ <br />
冲突产生一般可分为如下四个方面：</p>

<ol>
  <li>workdirectory的修改</li>
  <li>index的修改</li>
  <li>merge来源的修改</li>
  <li>merge之前的修改(Been committed)</li>
</ol>

<p>在merge manual中已经给出了一条合并操作的原则：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Command: git merge --help
Warning: Running git merge with non-trivial uncommitted changes is discouraged: while possible, it may leave you in a state that is hard to back out of in the case of a conflict.
// 简而言之，有未提交修改情况下，不要执行可能会冲突的操作！
</code></pre></div></div>

<p>在执行合并操作之前，保持workdirectory、index区域的clean特性，是非常必要的。当然，满足了这一前提，也并不代表就可以杜绝了冲突的可能。遵循该原则之后，解决的是1、2两点所产生的冲突可能，而前面所提及的3、4两点，是由于合并的操作所引入的冲突。  <br />
其实很多操作都可能会产生冲突，但最根本原因都是因为<code class="highlighter-rouge">merge</code>和<code class="highlighter-rouge">patch</code>，这两者是冲突的直接来源。例如如下操作都可能产生冲突，它们过程中也都包含了合并的性质：</p>

<ul>
  <li>rebase：重新设置基准，然后应用补丁</li>
  <li>pull：会自动merge</li>
  <li>repo sync：会自动rebase</li>
  <li>cherry-pick：会应用补丁</li>
  <li>…</li>
</ul>

<p>如何保持workdirectory、index区域的clean特性，可以参考上文文章已经阐述到的<code class="highlighter-rouge">stash</code>操作。在<code class="highlighter-rouge">merge</code>过程中一旦发生冲突，往往会停滞在merging状态中，这个时候，我们可以使用：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 中止merge过程，该命令会尽可能恢复到merge操作之前的状态，但也可能恢复失败。
git merge <span class="nt">--abort</span>

// merge manual原文是这么解释的：
<span class="nt">--abort</span>
	Abort the current conflict resolution process, and try to reconstruct the pre-merge state.
	If there were uncommitted worktree changes present when the merge started, git merge <span class="nt">--abort</span> will <span class="k">in </span>some cases be unable to reconstruct these changes.
	It is therefore recommended to always commit or stash your changes before running git merge.
	git merge <span class="nt">--abort</span> is equivalent to git reset <span class="nt">--merge</span> when MERGE_HEAD is present.
</code></pre></div></div>

<h4 id="二合并代码之前需要理解的概念">二、合并代码之前，需要理解的概念</h4>

<p><strong>1. FETCH_HEAD</strong></p>

<p><code class="highlighter-rouge">FETCH_HEAD</code>可以视为一个版本链接，或者说是版本commit-id的履历文件，该文件的路径在Git项目下的<code class="highlighter-rouge">.git/FETCH_HEAD</code>文件中。 <br />
当运行<code class="highlighter-rouge">git fetch remote_repo src_branch</code>类似的命令之时，将从远程repo获取分支的末端版本信息，记录到<code class="highlighter-rouge">.git/FETCH_HEAD</code>文件中：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ /jeromechan/project git:<span class="o">(</span>project<span class="o">)</span> ✗&gt;git fetch origin <span class="nb">test
</span>remote: Counting objects: 334, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>211/211<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 334 <span class="o">(</span>delta 177<span class="o">)</span>, reused 167 <span class="o">(</span>delta 51<span class="o">)</span>
Receiving objects: 100% <span class="o">(</span>334/334<span class="o">)</span>, 96.42 KiB | 0 bytes/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>177/177<span class="o">)</span>, completed with 70 <span class="nb">local </span>objects.
From https://github.com/jeromechan/project
 <span class="k">*</span> branch            <span class="nb">test</span>       -&gt; FETCH_HEAD
   f5a095a..18b49aa  <span class="nb">test</span>       -&gt; origin/test
</code></pre></div></div>

<p>然后，我们看下<code class="highlighter-rouge">.git/FETCH_HEAD</code>文件内容：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ /jeromechan/project git:<span class="o">(</span>project<span class="o">)</span> ✗&gt;vim .git/FETCH_HEAD

<span class="c">## 文件内容如下</span>
18b49aaa008731ff17768d6b18905fc5865b3aa7  branch <span class="s1">'test'</span> of https://github.com/jeromechan/project
</code></pre></div></div>

<p><strong>2. git fetch</strong></p>

<p>该命令可以将远程repo所包含的所有分支（或者指定分支）的最新commit-id记录到<code class="highlighter-rouge">.git/FETCH_HEAD</code>文件中。</p>

<p><strong>3. git pull</strong></p>

<p>该命令是GIT更新local repo和working copy的文件。在之前的文章中，提及过<code class="highlighter-rouge">git pull = git fetch + git merge FETCH_HEAD(by default)</code>，这里就不再重复提及了，如果想复习了解，请看“前言”中列出的几篇GIT基础知识文章。</p>

<p><strong>4. commit-id</strong></p>

<p>commit-id指的是每一次<code class="highlighter-rouge">git commit</code>操作所生成的每一个版本号，是一个能唯一标识一个版本的序列号。在使用git push后，这个序列号还会同步到远程repo。</p>

<h4 id="三如何执行合并操作">三、如何执行合并操作</h4>

<p>这里举例两个常见的场景对合并操作进行解释。</p>

<p><strong>1. 将相同分支下，已经产生分支冲突的代码，合并到本地working copy中</strong></p>

<p>这类场景下，由于分支是相同的，产生冲突无异于因为差异版本之间，相同的代码区块发生了相同位置的变更，然后冲突就这样产生了。 <br />
这类冲突不难解决，可以使用交互式命令行<code class="highlighter-rouge">git rebase</code>、Git-GUI客户端工具的rebase-from的操作，指定来源分支，借用其中的交互式操作，可以逐个逐个地进行<code class="highlighter-rouge">commit-id</code>的代码合并。</p>

<p><strong>2. 将其他分支B的代码差异，合并到当前工作分支A的working copy中</strong></p>

<p>这类场景常常发生在多人协作的实际工作中。例如需要将工作分支A的代码提交到分支B上，但分支B与工作分支A出现了不可合并的代码冲突，此时就需要将分支B的差异代码合并到当前的工作分支A中，然后再做提交与合并。</p>

<p>这个时候，我们可以按照如下几个步骤进行：</p>

<p>（1）git checkout A</p>

<p>将当前工作分支切换到分支A。</p>

<p>（2）git fetch https://github.com/jeromechan/project B</p>

<p>将分支B的末端版本（HEAD）检出到FETCH_HEAD文件中。</p>

<p>（3）git merge FETCH_HEAD</p>

<p>基于本地<code class="highlighter-rouge">.git/FETCH_HEAD</code>记录，比对本地工作分支A的版本与FETCH_HEAD所记录的分支B末端版本信息，利用<code class="highlighter-rouge">git merge</code>将分支B的差异内容合并更新到工作分支A中。 <br />
此操作过程中如果出现conflicts，那么是需要开发者进行自助解决的。这一部分，如果是整体作accept合并，那么一定要留意“theirs”和“mine”的关系，“theirs”通常指的是来源代码分支（即当前示例所述的分支B），而“mine”便是你的本地分支A了。</p>

<p>（4）git commit</p>

<p>将当前合并下来的commit-id及其内容提交到A分支上。</p>

<p>（5）git push https://github.com/jeromechan/project HEAD</p>

<p>将提交的commit-id及其变更内容，推送到远程repo的分支A上。</p>

<p>本篇到这里已阐述完。以上所述内容，一定可以帮助各位解决许多的合并代码的问题了。</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
          <a href="/2017/05/16/programming-principles/">
            Programming Principles(编程准则)
            <small>16 May 2017</small>
          </a>
      </li>
    
      <li>
          <a href="/2016/12/19/parallel-of-buying-scenario/">
            并发场景实践方案优劣评析
            <small>19 Dec 2016</small>
          </a>
      </li>
    
      <li>
          <a href="/2016/12/02/funny-function-invoking-logic/">
            几种方法调用思路的比较
            <small>02 Dec 2016</small>
          </a>
      </li>
    
      <li>
          <a href="/2016/09/23/feature-toggle-translation/">
            [译]Feature Toggle - Martin Fowler
            <small>23 Sep 2016</small>
          </a>
      </li>
    
      <li>
          <a href="/2016/09/06/db-master-slave-pattern-rules/">
            读写分离的原则
            <small>20 Sep 2016</small>
          </a>
      </li>
    
      <li>
          <a href="/2016/09/01/integrate-phpstorm-mamp-xdebug/">
            关于PhpStorm+MAMP+xdebug集成失败的处理办法
            <small>01 Sep 2016</small>
          </a>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//jeromedaily.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

  </body>

  <div style="display:none;">
	<script src="http://s23.cnzz.com/z_stat.php?id=1252898702&web_id=1252898702" language="JavaScript"></script>
</div>
  <div style="display:none;">
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?d8980c7390e74b30a59b00f31e279590";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
</div>
  
</html>
