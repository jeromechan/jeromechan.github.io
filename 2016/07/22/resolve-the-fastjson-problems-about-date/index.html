<!DOCTYPE html><html class=no-js><head><meta charset=utf-8 /><meta content=yes name=apple-mobile-web-app-capable /><meta content="IE=edge,chrome=1" http-equiv=X-UA-Compatible /><meta content="width=device-width, initial-scale=1, user-scalable=no" name=viewport /><title>解决fastjson反序列化日期0000-00-00失败的方案 — Jerome Chan | Web developer</title><link href="/assets/stylesheets/main-0365e952.css" rel=stylesheet /><link href="/assets/stylesheets/external-1d8576f8.css" rel=stylesheet /><link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/><link href="/assets/images/favicon/apple-icon-72x72-6b070105.png" rel=apple-touch-icon sizes=72x72 /><link href="/assets/images/favicon/favicon-32x32-eb4149d8.png" rel=icon sizes=32x32 type="image/png"/><link href="/assets/images/favicon/manifest.json" rel=manifest /><meta content="#f7f7f7" name=msapplication-TileColor /><meta content="#f7f7f7" name=theme-color /><div style="display:none"><script src="http://s23.cnzz.com/z_stat.php?id=1252898702&web_id=1252898702"></script></div><meta content="解决fastjson反序列化日期0000-00-00失败的方案 — Jerome Chan | Web developer" property="og:title"/><meta content="Jerome Chan" property="article:author"/><meta content="Jerome Chan" property="article:publisher"/><meta content="Jerome Chan | Web developer" property="og:site_name"/><meta content=summary name="twitter:card"/><meta content="@jeromechan369" name="twitter:site"/><meta content="解决fastjson反序列化日期0000-00-00失败的方案 — Jerome Chan | Web developer" name="twitter:title"/><meta content="解决fastjson反序列化日期0000-00-00失败的方案" name=description /><meta content="fastjson,date,0000-00-00,deserialize" name=keywords /><meta href="http://aboutcoder.com/2016/07/22/resolve-the-fastjson-problems-about-date/" rel=canonical /><meta content="Web developer" property="og:description"/><meta content=website property="og:type"/><meta content="http://aboutcoder.com/assets/images/social-1a50db15.png" property="og:image"/><meta content="http://aboutcoder.com/2016/07/22/resolve-the-fastjson-problems-about-date/" property="og:url"/><meta content="Jerome Chan" property="og:site_name"/><meta content="Web developer" property="twitter:description"/><meta content="http://aboutcoder.com/assets/images/social-1a50db15.png" property="twitter:image"/><meta content="Web developer" property="og:description"/><meta content=article property="og:type"/><meta content="http://aboutcoder.com/assets/images/social-1a50db15.png" property="og:image"/><meta content="http://aboutcoder.com/2016/07/22/resolve-the-fastjson-problems-about-date/" property="og:url"/><meta content="Web developer" property="twitter:description"/><meta content="http://aboutcoder.com/assets/images/social-1a50db15.png" property="twitter:image"/></head><body class="x2016 x2016-07 x2016_07_22 x2016_07_22_resolve-the-fastjson-problems-about-date x2016_07_22_resolve-the-fastjson-problems-about-date_index single"><a class=toggle-nav role=button data-toggle=nav href="#"><svg height=34 viewbox="0 0 512 512" width=34 xmlns="http://www.w3.org/2000/svg"><path class=menu-path d="M80 96a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h352a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16H80zm0 128a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h352a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16H80zm0 128a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h352a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16H80z" fill="#fff"></path></svg></a><nav class=nav id=nav role=nav><a class=nav-close role=button data-toggle=nav href="#"><svg height=30 viewbox="0 0 304 305" width=30 xmlns="http://www.w3.org/2000/svg"><title>close</title><path d="M106.745 152.68L4.922 50.855c-6.25-6.25-6.25-16.38 0-22.628L27.55 5.6c6.248-6.247 16.378-6.247 22.627 0L152 107.425 253.823 5.6c6.25-6.247 16.38-6.247 22.628 0L299.08 28.23c6.25 6.25 6.25 16.38 0 22.628L197.255 152.68 299.078 254.5c6.25 6.25 6.25 16.38 0 22.628l-22.627 22.627c-6.248 6.25-16.378 6.25-22.627 0L152 197.934 50.177 299.757c-6.25 6.25-16.38 6.25-22.628 0L4.92 277.13c-6.25-6.248-6.25-16.38 0-22.628L106.745 152.68z" fill="#fff" fill-rule=evenodd></path></svg></a><div class=nav-inner><h2>Navigation</h2><ul class=navbar><li><a title="About me" href="/about"><i class="fa fa-user"></i> About me</a></li><li><a href="/blog"><i class="fa fa-list"></i> My blog</a></li><li><a href="/bibliography"><i class="fa fa-book"></i> Bibliography</a></li><li><a target=blank href="/webdevtools"><i class="fa fa-wrench"></i> Web Dev Tools</a></li></ul></div></nav><main class=site-main role=main><header class=header><div class=hero-particles-js id=particles-js></div><div class=header__inn><div class=js-text-parallax><h1 class=header__logo><span><a href="/">Jerome Chan</a><small>Web Developer at Tuniu Corp</small></span></h1><nav class=header__social-nav><ul class=social><li><a target=blank href="http://weibo.com/5812529126"><svg height=36 viewbox="0 0 512 512" width=36 xmlns="http://www.w3.org/2000/svg"><path d="m480.153062,214.151771c0,0.024196 0,0.048392 0,0.072589c-2.987788,9.000986 -12.852428,13.937011 -22.038025,11.021369c-9.210289,-2.915642 -14.247552,-12.582023 -11.27211,-21.607206l-0.012346,0c9.136212,-27.716746 3.345829,-59.32908 -17.976114,-82.509038c-21.33429,-23.179959 -52.79249,-32.023669 -81.867867,-25.97462c-9.457214,1.97199 -18.753927,-3.94398 -20.766363,-13.211125c-2.024782,-9.242948 4.000179,-18.364915 13.457393,-20.361101l0.012346,0c40.866029,-8.517062 85.139619,3.919784 115.15331,36.560457c30.026037,32.59228 38.125166,77.028599 25.309776,116.008676zm-121.21531,-64.119927l0,-0.012098c-8.111475,1.730028 -16.12418,-3.37537 -17.864998,-11.335919c-1.740819,-7.984746 3.444599,-15.836412 11.580766,-17.530146c19.914473,-4.161746 41.483341,1.875205 56.10128,17.772108c14.630285,15.884805 18.556387,37.528305 12.296847,56.522321c-2.55567,7.76698 -11.049878,12.001315 -18.963813,9.521204c-7.926281,-2.516405 -12.247463,-10.851995 -9.691792,-18.606877l-0.024692,0c3.074212,-9.29134 1.1482,-19.877177 -6.000269,-27.644157c-7.136122,-7.754882 -17.692151,-10.69472 -27.433328,-8.686435zm6.037308,27.632059c7.913935,11.081859 7.148469,26.615819 -0.148155,44.617791c-3.370521,8.287198 1.04943,9.569597 7.481817,11.468998c26.211051,7.960549 55.397545,27.24492 55.397545,61.204285c0,56.219868 -82.682718,127.030044 -206.984586,127.030044c-94.806719,0 -191.724643,-45.053322 -191.724643,-119.16628c0,-38.738114 25.038159,-83.537377 68.138857,-125.808136c57.570482,-56.425536 124.696947,-82.133997 149.944993,-57.369188c11.136302,10.912486 12.210424,29.809717 5.049609,52.372673c-3.728562,11.360115 10.877031,5.069104 10.877031,5.0933c46.53295,-19.102899 87.127362,-20.228022 101.967534,0.556513zm-15.889601,116.274834c-4.901454,-48.682752 -70.213024,-82.218684 -145.883082,-74.887236c-75.645366,7.343546 -133.018308,52.759812 -128.104508,101.454662c4.913801,48.706948 70.22537,82.230782 145.883082,74.911432c75.670058,-7.331448 133.005962,-52.759812 128.104508,-101.478858zm-177.032627,80.561244c-36.372001,-11.517391 -51.767753,-46.72286 -35.841113,-78.444077c15.642676,-31.104214 56.323512,-48.69485 92.325126,-39.512393c37.260929,9.436518 56.274127,43.904003 41.051223,77.367346c-15.445137,34.24972 -59.854535,52.505752 -97.535236,40.589124zm20.544131,-66.672626c-11.716575,-4.815044 -26.853056,0.133079 -34.087948,11.251232c-7.321316,11.166546 -3.876717,24.462357 7.753434,29.652442c11.802998,5.286869 27.470367,0.266158 34.791683,-11.178644c7.185507,-11.565783 3.395214,-24.776908 -8.457169,-29.72503zm28.877838,-11.735156c-4.494029,-1.754224 -10.111564,0.362943 -12.753658,4.706161c-2.55567,4.355316 -1.1482,9.315537 3.358175,11.130251c4.580452,1.851009 10.432566,-0.278256 13.07466,-4.718259c2.530978,-4.464199 0.888929,-9.48491 -3.679177,-11.118153z" fill="#fff"></path></svg></a></li><li><a target=blank href="https://github.com/jeromechan"><svg height=36 viewbox="0 0 512 512" width=36 xmlns="http://www.w3.org/2000/svg"><path d="M512 250v-2c-42.158-8.427-85.827-9.087-112-8 4.3-15.487 6-32.128 6-52 0-28.5-10.611-52.65-28-70 3.038-9.805 7.15-30.123-4-58 0 0-19.504-7.772-64 22-17.43-4.355-35.422-6-54-6-20.44 0-42.736 2.717-62 8-45.917-31.315-66-24-66-24-13.23 33.077-4.485 55.918-2 62-15.55 16.78-26 39.74-26 66 0 19.824 2.486 36.543 8 52-26.396-.96-67.346-.127-108 8v2c40.9-8.177 83.765-8.993 110-8 1.215 3.2 2.482 7 4 10-25.944.836-71.545 4.027-114 16l2 2c42.79-12.06 86.308-15.214 112-16 15.5 28.886 45.63 46.14 100 52-7.717 5.184-14.81 15.09-18 30-10.516 5.028-44.028 16.342-64-18 0 0-10.6-20.4-32-22 0 0-21.326.75-2 14 0 0 14.416 5.41 24 30 .298 0 11.67 43.456 72 30v42c-.298 0 .052 14.894-14 20 0 0-8.945 6.812 0 10 .032 0 38 3.917 38-28v-48c.34 0-1.206-17.488 8-24v76c-.37 0-.42 18.977-10 26 0 0-6.05 11.188 8 8 0 0 26.722-4.72 28-36v-78h8v78c1.276 31.28 28 36 28 36 14.047 3.188 8-8 8-8-9.96-7.023-10-26-10-26v-76c9.54 7.163 8 24 8 24v48c.044 31.918 38 28 38 28 8.937-3.188 0-10 0-10-14.36-5.106-14-20-14-20v-62c.31-24.147-10.054-37.25-20-44 57.983-5.748 85.18-22.92 98-52 25.398.698 70.28 3.67 114 16l2-2c-43.47-12.257-90.345-15.253-116-16 1.215-2.938 3.058-6.857 4-10 41.325.51 78.074 1.154 112 8z" fill="#fff"></path></svg></a></li><li><a target=blank href="/feed.xml"><svg height=36 viewbox="0 0 512 512" width=36 xmlns="http://www.w3.org/2000/svg"><path d="M64 64v72c172.313 0 312 139.687 312 312h72C448 235.923 276.077 64 64 64zm0 144v72c92.784 0 168 75.216 168 168h72c0-132.548-107.452-240-240-240zm48 144c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z" fill="#fff"></path></svg></a></li></ul></nav></div><a href="/"><img class=header__avatar height=250px src="/assets/images/avatar-8dced784.png" srcset="/assets/images/avatar-8dced784.png 1x" width=250px /></a></div></header><article class=article itemscope="" itemtype="http://schema.org/NewsArticle" role=article><div class=container-inn><header class=article-header><meta content=2016-07-22 itemprop=datePublished /><span class=article-meta>Posted on the July 22, 2016</span><h1 class=article-title itemprop=headline>解决fastjson反序列化日期0000-00-00失败的方案</h1></header><div class=article-tags><i class="fa fa-tags">&nbsp;<a target=blank href="/tags/fastjson/">fastjson</a></i></div><div class=article-content itemprop=articleBody><h4>一、案例场景复原</h4> <p>示例场景里涉及两个class：<code>TestDemo.java</code>, <code>DateBeanDemo.java</code>。</p> <pre class="highlight java"><code><span class="c1">// DateBeanDemo.java</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DateBeanDemo</span> <span class="o">{</span>
    <span class="cm">/**
     * dateStr field with Date.class
     */</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">dateStr</span><span class="o">;</span>

    <span class="cm">/**
     * Get dateStr &lt;br&gt;
     *
     * @return Returns the dateStr. &lt;br&gt;
     */</span>
    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getDateStr</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dateStr</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Set dateStr &lt;br&gt;
     *
     * @param dateStr The dateStr to set. &lt;br&gt;
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDateStr</span><span class="o">(</span><span class="n">Date</span> <span class="n">dateStr</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dateStr</span> <span class="o">=</span> <span class="n">dateStr</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre> <pre class="highlight java"><code><span class="c1">// 示例执行例子</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">jsonStr</span> <span class="o">=</span> <span class="s">"{\"dateStr\":\"0000-00-00\"}"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">DateBeanDemo</span> <span class="n">resultObject</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">TestDemo</span><span class="o">.</span><span class="na">jsonStr</span><span class="o">,</span> <span class="n">DateBeanDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre> <p>执行以上的main方法之后，并没有获取预期的结果，而是在fastjson的序列化解析中便发生了异常，如下</p> <pre class="highlight plaintext"><code>Exception in thread "main" com.alibaba.fastjson.JSONException: For input string: "0000-00-00"
    at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:555)
    at com.alibaba.fastjson.JSON.parseObject(JSON.java:251)
    at com.alibaba.fastjson.JSON.parseObject(JSON.java:227)
    at com.alibaba.fastjson.JSON.parseObject(JSON.java:186)
    at excel.TestDemo.main(TestDemo.java:23)
Caused by: java.lang.NumberFormatException: For input string: "0000-00-00"
    at java.lang.NumberFormatException.forInputString(NumberFormatException.java:48)
    at java.lang.Long.parseLong(Long.java:419)
    at java.lang.Long.parseLong(Long.java:468)
    at com.alibaba.fastjson.parser.deserializer.DateDeserializer.cast(DateDeserializer.java:56)
    at com.alibaba.fastjson.parser.deserializer.AbstractDateDeserializer.deserialze(AbstractDateDeserializer.java:98)
    at Fastjson_ASM_DateBeanDemo_1.deserialze(Unknown Source)
    at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:551)
    ... 4 more
</code></pre> <p>通过百度查阅了部分网上撰写的方案，可以使用fastjson中的注解<code>@JSONField(format=&quot;&quot;)</code>来重新定义<code>DateBeanDemo.dateStr</code>，如下：</p> <pre class="highlight java"><code><span class="nd">@JSONField</span><span class="o">(</span><span class="n">format</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd"</span><span class="o">,</span><span class="n">parseFeatures</span><span class="o">={</span><span class="n">Feature</span><span class="o">.</span><span class="na">AllowISO8601DateFormat</span><span class="o">})</span>
<span class="kd">private</span> <span class="n">Date</span> <span class="n">dateStr</span><span class="o">;</span>
</code></pre> <p>然而，并没有解决这个exception的问题。同时还怀疑了注解是否在反序列化之时没有被使用到，经过查阅源码，fastjson已将其反序列化的开关定义了<code>true</code>。</p> <pre class="highlight java"><code><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">,</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">JSONField</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">ordinal</span><span class="o">()</span> <span class="k">default</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">String</span> <span class="nf">name</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
    <span class="n">String</span> <span class="nf">format</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="nf">serialize</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="nf">deserialize</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// 默认定义了true，反序列化之时也使用该注解</span>
    <span class="n">SerializerFeature</span><span class="o">[]</span> <span class="nf">serialzeFeatures</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
    <span class="n">Feature</span><span class="o">[]</span> <span class="nf">parseFeatures</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
    <span class="n">String</span> <span class="nf">label</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
<span class="o">}</span>
</code></pre> <h4>二、原因剖析</h4> <p>经查找fastjson中相关代码发现，当代码执行到<code>com.alibaba.fastjson.parser.deserializer.DateDeserializer.class</code>的执行方法<code>cast()</code>中之时，所使用的JSONParser中所含带的dateFormat依旧是默认的<code>yyyy-MM-dd HH:mm:ss</code>，而并非注解@JSONField中所定义的<code>yyyy-MM-dd</code>。 所以发生了转换字段失败。</p> <p><img alt=14691655278897 width=1552 height=776 src="/images/2016-07-22-resolve-the-fastjson-problems-about-date/14691655278897-9bc00afe.jpg"/></p> <p>再深究一层，为什么不是@JSONField中所定义的<code>yyyy-MM-dd</code>作为JSONParser中的dateFormat呢？其实仔细阅读一遍<code>cast()</code>代码逻辑就会发现，并不是fastjson丢弃了JSONField的扫描，而是在方法中有这么一段：</p> <pre class="highlight java"><code><span class="c1">// 检查格式是否符合ISO8601的DateFormat规范</span>
<span class="k">if</span><span class="o">(!</span><span class="n">dateLexer</span><span class="o">.</span><span class="na">scanISO8601DateIfMatch</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">break</span> <span class="n">label122</span><span class="o">;</span>
<span class="o">}</span>
</code></pre> <p>当执行到以上代码段之时，由于字符串<code>0000-00-00</code>并不是ISO8601的DateFormat规范之内，故而代码便会<code>break label122</code>执行跳出逻辑。紧接着执行的就是<code>DateFormat dateFormat1 = parser.getDateFormat();</code>，此时，parser依然是global定义的parser，DateFormat并没有使用<code>@JSONField</code>中所定义的。</p> <h4>三、解决方案：新增date反序列化解析器</h4> <p>解决方案并非只有一种，在众多解决方案中自己选择了&quot;新增date反序列化解析器&quot;的办法。除此之外还有诸如设置<code>JSON.DEFFAULT_DATE_FORMAT</code>属性的办法，也同样可以解决这一问题。下面作两种办法的对比和阐述。</p> <ul> <li>方案1：设置属性<code>JSON.DEFFAULT_DATE_FORMAT</code> </li> </ul> <p>这一方案只涉及修改<code>main()</code>方法代码即可实现，</p> <pre class="highlight java"><code><span class="c1">// 示例执行例子</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">jsonStr</span> <span class="o">=</span> <span class="s">"{\"dateStr\":\"0000-00-00\"}"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">JSON</span><span class="o">.</span><span class="na">DEFFAULT_DATE_FORMAT</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd"</span><span class="o">;</span>
        <span class="n">DateBeanDemo</span> <span class="n">resultObject</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">TestDemo</span><span class="o">.</span><span class="na">jsonStr</span><span class="o">,</span> <span class="n">DateBeanDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre> <p>但是翻阅fastjson中对于<code>JSON.DEFFAULT_DATE_FORMAT</code>可知，该属性属于静态属性，一旦设置影响全局。</p> <pre class="highlight plaintext"><code>// com.alibaba.fastjson.JSON.class
public abstract class JSON implements JSONStreamAware, JSONAware {
    public static String DEFFAULT_DATE_FORMAT;
    // ...
</code></pre> <ul> <li>方案2：新增date反序列化解析器</li> </ul> <p>主要思路是以fastjson原生的<code>DateDeserializer.class</code>为基础，定制化一个可以解析<code>0000-00-00</code>的日期反序列化解析器。<br> 该方式是fastjson函数<code>JSON.parseObject()</code>的一个应用场景，通过定制化<code>ParserConfig</code>参数，达到局部改变JSON解析逻辑的目的。<br> 如下：</p> <pre class="highlight java"><code><span class="kn">package</span> <span class="n">jeromechan</span><span class="o">.</span><span class="na">fixbug</span><span class="o">.</span><span class="na">fastjson</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.DefaultJSONParser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.alibaba.fastjson.parser.deserializer.DateDeserializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Type</span><span class="o">;</span>

<span class="cm">/**
 * Copyright © 2016 Jerome Chan. All rights reserved.
 * An extended DateDeseializer for parsing '0000-00-00'.
 * 
 * @author chenjinlong
 * @CreateDate 7/20/16 5:55 PM
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JCDateDeserializer</span> <span class="kd">extends</span> <span class="n">DateDeserializer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">JCDateDeserializer</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JCDateDeserializer</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">JCDateDeserializer</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">cast</span><span class="o">(</span><span class="n">DefaultJSONParser</span> <span class="n">parser</span><span class="o">,</span> <span class="n">Type</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">Object</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">Object</span> <span class="n">val</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">strVal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">val</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">strVal</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strVal</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"0000-00-00"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">parser</span><span class="o">.</span><span class="na">setDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">parser</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre> <pre class="highlight java"><code><span class="c1">// 示例执行例子</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">jsonStr</span> <span class="o">=</span> <span class="s">"{\"dateStr\":\"0000-00-00\"}"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>        
        <span class="n">ParserConfig</span> <span class="n">jcParserConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ParserConfig</span><span class="o">();</span>
        <span class="n">jcParserConfig</span><span class="o">.</span><span class="na">putDeserializer</span><span class="o">(</span><span class="n">Date</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">JCDateDeserializer</span><span class="o">.</span><span class="na">instance</span><span class="o">);</span>
        <span class="n">DateBeanDemo</span> <span class="n">resultObject</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">TestDemo</span><span class="o">.</span><span class="na">jsonStr</span><span class="o">,</span> <span class="n">DateBeanDemo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">jcParserConfig</span><span class="o">,</span> <span class="n">JSON</span><span class="o">.</span><span class="na">DEFAULT_PARSER_FEATURE</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre> <p>假设觉得这种解析办法可以作为整个项目内的全局特性，感兴趣的话可以将定制好的<code>JCDateDeserializer</code>利用spring框架注入到项目容器中。这同样是对于方案2很不错的延伸。</p> <h4>四、参考资料</h4> <ul> <li>fastjson在github上的issues：<a href="https://github.com/alibaba/fastjson/issues/414">https://github.com/alibaba/fastjson/issues/414</a></li> </ul> </div></div></article><aside class=comments id=comments><div class=container-inn><div id=disqus_thread></div></div></aside><script>var disqus_shortname = "aboutcoder";
var disqus_identifier = "/2016/07/22/resolve-the-fastjson-problems-about-date/";
var disqus_title = "解决fastjson反序列化日期0000-00-00失败的方案";
var disqus_url = "http://aboutcoder.com/2016/07/22/resolve-the-fastjson-problems-about-date/";
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the<a href="https://disqus.com/?ref_noscript" rel=nofollow> comments powered by Disqus.</a></noscript><div class=search><div class=search__form><input class=search__input placeholder="example: lorem ipsem"/></div><ul class=search__results></ul></div><footer class=footer><small>Refactored with ❤ by <a href="http://aboutcoder.com">Jerome Chan</a> using <a target=blank href="http://middlemanapp.com">middleman</a><br/>Copyright © 2013-2016</small></footer><script async=true data-cfasync=false id=dsq-count-scr src="//aboutcoder.disqus.com/count.js"></script><script src="/assets/javascripts/main-03542d2a.js"></script></main></body></html>